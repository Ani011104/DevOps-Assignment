name: Deploy to AWS and GCP (main)

on:
  push:
    branches: [ main ]

env:
  IMAGE_TAG: ${{ github.sha }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # ---------- TOOLS ----------
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.10.0

      # ---------- AUTH ----------
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - uses: google-github-actions/setup-gcloud@v2

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - uses: aws-actions/amazon-ecr-login@v1
        id: ecr

      - run: |
          gcloud auth configure-docker \
            ${{ secrets.GCP_REGION }}-docker.pkg.dev --quiet

      # TERRAFORM APPLY (BOOTSTRAP)
      - name: Terraform AWS (bootstrap)
        working-directory: infra/aws
        run: |
          terraform init -reconfigure
          terraform apply -auto-approve \
            -var="backend_image=nginx:alpine" \
            -var="frontend_image=nginx:alpine" \
            -var="ecs_execution_role_arn=${{ secrets.ECS_EXECUTION_ROLE_ARN }}" \
            -var="alert_email=${{ secrets.ALERT_EMAIL }}"

          echo "AWS_BACKEND_URL=http://$(terraform output -raw alb_dns)/api" >> $GITHUB_ENV

      - name: Terraform GCP (bootstrap)
        working-directory: infra/gcp
        run: |
          terraform init -reconfigure
          terraform apply -auto-approve \
            -var="project_id=${{ secrets.GCP_PROJECT_ID }}" \
            -var="region=${{ secrets.GCP_REGION }}" \
            -var="artifact_registry_repo=pg-agi-docker" \
            -var="backend_image=pgagi-backend" \
            -var="frontend_image=pgagi-frontend" \
            -var="image_tag=${GCP_IMAGE_TAG}"

          echo "GCP_BACKEND_URL=$(terraform output -raw backend_url)" >> $GITHUB_ENV

      # BUILD & PUSH IMAGES
      - name: Build & Push Images
        run: |
          TAG=${IMAGE_TAG::7}
          AWS_REG=${{ steps.ecr.outputs.registry }}

          AWS_BACKEND=$AWS_REG/pgagi-backend:$TAG
          AWS_FRONTEND=$AWS_REG/pgagi-frontend:$TAG

          GCP_BACKEND=${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/pg-agi-docker/pgagi-backend:$TAG
          GCP_FRONTEND=${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/pg-agi-docker/pgagi-frontend:$TAG

          docker build -t $AWS_BACKEND ./backend
          docker push $AWS_BACKEND

          docker build \
            --build-arg NEXT_PUBLIC_API_URL=$AWS_BACKEND_URL \
            -t $AWS_FRONTEND ./frontend
          docker push $AWS_FRONTEND

          docker tag $AWS_BACKEND $GCP_BACKEND
          docker push $GCP_BACKEND

          docker build \
            --build-arg NEXT_PUBLIC_API_URL=$GCP_BACKEND_URL \
            -t $GCP_FRONTEND ./frontend
          docker push $GCP_FRONTEND

          echo "AWS_BACKEND_IMAGE=$AWS_BACKEND" >> $GITHUB_ENV
          echo "AWS_FRONTEND_IMAGE=$AWS_FRONTEND" >> $GITHUB_ENV

      
      # DEPLOY REAL IMAGES
      
      - name: Terraform AWS Deploy
        working-directory: infra/aws
        run: |
          terraform apply -auto-approve \
            -var="backend_image=$AWS_BACKEND_IMAGE" \
            -var="frontend_image=$AWS_FRONTEND_IMAGE" \
            -var="ecs_execution_role_arn=${{ secrets.ECS_EXECUTION_ROLE_ARN }}" \
            -var="alert_email=${{ secrets.ALERT_EMAIL }}"

      - name: Terraform GCP Deploy
        working-directory: infra/gcp
        run: |
          terraform apply -auto-approve \
            -var="project_id=${{ secrets.GCP_PROJECT_ID }}" \
            -var="region=${{ secrets.GCP_REGION }}" \
            -var="artifact_registry_repo=pg-agi-docker" \
            -var="backend_image=pgagi-backend" \
            -var="frontend_image=pgagi-frontend" \
            -var="image_tag=${TAG}"
